<?xml version="1.0" encoding="UTF-8"?>
<project name="Atlassian Eclipse Connector" default="all" basedir=".">
	<property file="${build.config}" />
	<property file="local.properties" />
	<import file="scripts/osHelper.xml" />
	<property file="defaults.properties" />
	<import file="scripts/buildHelper.xml" />
	
	<target name="all" depends="clean,build,tests">
	</target>

	<target name="dev" depends="clean,build,pack,generate-metadata">
	</target>

	<target name="pre-build">
		<antcall target="install-bundle">
			<param name="update.feature" value="org.tigris.subversion.clientadapter.feature"/>
			<param name="update.site" value="${subclipse.site}"/>
			<param name="update.version" value="1.5.2"/>
		</antcall>
		<antcall target="install-bundle">
			<param name="update.feature" value="org.tigris.subversion.subclipse"/>
			<param name="update.site" value="${subclipse.site}"/>
			<param name="update.version" value="1.4.7"/>
		</antcall>
	</target>
	
	<target name="pack" depends="init,init-3.4">
		<antcall target="for-each-target">
			<param name="call" value="pack-sites"/>
		</antcall>
	</target>
	
	<target name="pack-sites" depends="init">
		<antcall target="pack-helper">
			<param name="dir" value="${build.home}/${build.target}/site"/>
		</antcall>
	</target>

	<target name="generate-metadata" depends="init,init-3.4">
		<antcall target="for-each-target">
			<param name="call" value="generate-metadata-sites"/>
		</antcall>
	</target>
	
	<target name="generate-metadata-sites" depends="init">
		<antcall target="generate-metadata-helper">
			<param name="dir" value="${build.home}/${build.target}/site"/>
			<param name="name" value="Atlassian Eclipse Connector"/>
		</antcall>
	</target>

	<target name="publish" depends="init">
		<fail message="Required property build.publish.user is not set" unless="build.publish.user"/>
		<fail message="Required property build.publish.password is not set" unless="build.publish.password"/>
		<fail message="Required property build.publish.location is not set" unless="build.publish.location"/>
		
		<property name="build.publish.release" value="/nightly"/>
		<echo message="Uploading ${version}.${qualifier} to ${build.publish.release}" />
		<scp todir="${build.publish.user}@${build.publish.location}${build.publish.release}" password="${build.publish.password}" trust="true" verbose="true">
			<fileset dir="${build.home}/3.3/site"/>
		</scp>
	</target>	

	<target name="init-3.4">
		<antcall target="get-build-dependencies-helper">
			<param name="build.target" value="3.4"/>
			<param name="eclipse.sdk.url" value="${eclipse.url.3.4}"/>
			<param name="eclipse.sdk.version" value="${eclipse.sdk.3.4}"/>
		</antcall>
	</target>
	
</project>
